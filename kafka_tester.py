import asyncio
import json
import uuid
from aiokafka import AIOKafkaProducer, AIOKafkaConsumer

# KAFKA_BOOTSTRAP_SERVERS = "kafka:9092"
KAFKA_BOOTSTRAP_SERVERS = "localhost:29092"
KAFKA_REQUEST_TOPIC = "descRequests"
KAFKA_RESPONSE_TOPIC = "descResponses"


async def main():
    """
    Sends a single image description request to Kafka and waits for the response.
    """
    request_id = str(uuid.uuid4())
    print(f"🚀 Starting Kafka test with request_id: {request_id}")

    producer = AIOKafkaProducer(bootstrap_servers=KAFKA_BOOTSTRAP_SERVERS)
    consumer = AIOKafkaConsumer(
        KAFKA_RESPONSE_TOPIC,
        bootstrap_servers=KAFKA_BOOTSTRAP_SERVERS,
        group_id=f"test-consumer-{request_id}",
        auto_offset_reset="latest"
    )
    await producer.start()
    await consumer.start()
    print("✅ Kafka producer and consumer connected.")

    try:
        image_b64 = "data:image/png;base64,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"
        payload = {"request_id": request_id, "image_base64": image_b64}
        message = json.dumps(payload).encode("utf-8")
        await producer.send_and_wait(KAFKA_REQUEST_TOPIC, message)
        print(f"📬 Message sent to topic '{KAFKA_REQUEST_TOPIC}'")
        print(f"👂 Listening for response on topic '{KAFKA_RESPONSE_TOPIC}'...")
        response_received = False
        async for msg in consumer:
            response_data = json.loads(msg.value.decode("utf-8"))
            if response_data.get("request_id") == request_id:
                print("\n🎉 SUCCESS! Full round-trip complete.")
                print(f"   Request ID:  {response_data.get('request_id')}")
                print(f"   Description: '{response_data.get('description')}'")
                response_received = True
                break
            else:
                print(f"   (Skipping message with unrelated request_id: {response_data.get('request_id')})")
        if not response_received:
            print("\n❌ FAILED: Consumer finished without receiving the expected response.")
    except Exception as e:
        print(f"\n❌ An error occurred during the test run: {e}")
    finally:
        print("\n🧹 Shutting down Kafka clients...")
        await producer.stop()
        await consumer.stop()
        print("🛑 Test finished.")
if __name__ == "__main__":
    try:
        asyncio.run(asyncio.wait_for(main(), timeout=60.0))
    except asyncio.TimeoutError:
        print("\n❌ FAILED: The entire test script timed out after 60 seconds.")
    except Exception as _:  # noqa: F841
        print(f"\n❌ FAILED: Could not connect to Kafka at '{KAFKA_BOOTSTRAP_SERVERS}'. Is it running?")
